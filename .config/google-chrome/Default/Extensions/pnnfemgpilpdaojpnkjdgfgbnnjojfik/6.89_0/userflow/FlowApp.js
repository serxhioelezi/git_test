import{r as e}from"./vendor.react.js";import{E as t,V as o,J as n,b as s,K as r,H as l,L as a,x as i,D as c,M as u,U as d}from"./userflow.js";import{B as p}from"./BubbleToolbar.js";import{m,d as f,R as b,i as h,g as w,u as g,c as E,h as v,S as y}from"./bubble-frame.styl.js";import{b as k,z as j,a as T,t as S,r as R}from"./flow-condition-types.js";import{u as L,i as M}from"./client-context.js";import{F as x}from"./FlowChrome.js";import{u as F,r as C}from"./use-selector-element-monitoring.js";import{a as I,S as N}from"./flow-host.styl.js";import{m as D}from"./vendor.fortawesome.pro-solid-svg-icons.js";import{D as P,u as B}from"./stylesheets.js";import{T as q}from"./Trigger.js";import{u as _}from"./vendor.react-i18next.js";import"./vendor.object-assign.js";import"./vendor.phoenix.js";import"./vendor.uuid.js";import"./vendor.fortawesome.pro-regular-svg-icons.js";import"./vendor.obj-str.js";import"./vendor.date-fns.js";import"./vendor.i18next.js";import"./use-window-resize.js";import"./vendor.react-dom.js";import"./vendor.scheduler.js";import"./logomark.js";import"./vendor.babel.runtime.js";const A=()=>{const{t:o}=_(),n=L(),{dispatch:s,restart:r}=le(),{session:l,step:a}=ae(),i="userflowjs-bubble-button userflowjs-bubble-button--default userflowjs-bubble-menu__item";return e.createElement("div",{role:"dialog","aria-modal":ne(a)?"true":void 0,"aria-label":"Guide menu"},e.createElement("div",{className:"userflowjs-bubble-menu__title"},o("menu.title")),e.createElement("button",{className:i,onClick:()=>n.endFlow(l,{endReason:t.USER_CLOSED})},o("menu.close")),l.version.restartEnabled&&e.createElement("button",{className:i,onClick:r},o("menu.restart")),e.createElement("button",{className:i,onClick:()=>s({kind:"showFlow"})},o("menu.back")))},O=({progress:t})=>{const o={width:100*parseFloat(t||"0")+"%"};return e.createElement("div",{className:"userflowjs-bubble-progress"},e.createElement("div",{className:"userflowjs-bubble-progress__fill",style:o}))},V=({theme:s})=>{const r=L(),{session:l,step:a,muted:i,shouldLabelDialog:c}=ae(),{version:u}=l,{dispatch:d}=le(),h=u.steps[0],w=h&&h.id===a.id,g=w&&"1"===a.progress,E=e.useMemo((()=>a.content&&m(f(a.content),{buttons:a.buttons,questions:a.questions})),[a.content,a.buttons,a.questions]);return e.createElement("div",{key:a.id,role:"alertdialog","aria-modal":ne(a)?"true":void 0,"aria-label":c?"Guide":void 0},!g&&e.createElement(O,{progress:a.progress}),e.createElement("div",{id:"userflowjs-bubble-content",className:"userflowjs-bubble-content"},e.createElement(b,{doc:E,lookupAttribute:k(l.data),buttons:a.buttons,questions:a.questions})),e.createElement(p,{draftMode:l.draftMode,muted:i,toggleMuted:s.voiceType!==o.NONE?()=>d({kind:"toggleMuted"}):void 0,close:u.closeDisabled?void 0:()=>s.flowXButtonBehavior===n.DISMISS||w?r.endFlow(l,{endReason:t.USER_CLOSED}):d({kind:"showMenu"})}))};function U(e,t){if(!e)return"";"string"==typeof e&&(e=f(e));const o=[],n=/[.!?;,]$/;function s(){const e=(o[o.length-1]||"").trim();e&&!e.match(n)&&o.push(".")}function r(e){e.forEach((e=>function(e){if(h(e)){if(e.text&&!e.silent){const t=e.text.split("\n");t.forEach(((e,n)=>{o.push(e),n<t.length-1&&(s(),o.push("\n"))}))}}else switch(e.type){case"attribute":{const n=w(e,t);n&&o.push(n);break}default:r(e.children),["link"].includes(e.type)||(s(),o.push("\n\n"))}}(e)))}return r(e.children),o.join("").trim().replace(new RegExp(String.fromCharCode(160),"g")," ").replace(new RegExp(String.fromCharCode(8),"g"),"")}const z=({bubbleFrame:t,theme:n})=>{const s=L(),{dispatch:r}=le(),{muted:l,session:a,step:i}=ae(),c=s.getAudio();e.useEffect((()=>{const e=()=>{r({kind:"speechPlaying"})},t=()=>{r({kind:"speechStopped"})};return c.addEventListener("playing",e),c.addEventListener("ended",t),c.addEventListener("pause",t),()=>{c.removeEventListener("playing",e),c.removeEventListener("ended",t),c.removeEventListener("pause",t),c.pause(),c.src="",r({kind:"speechStopped"})}}),[r,c]),e.useEffect((()=>{if(s.audioReady)return;const e=t&&"IFRAME"===t.tagName?t.contentWindow:null;const o=()=>{window.removeEventListener("mousedown",n),e&&e.removeEventListener("mousedown",n)},n=()=>{o(),s.playAudio(null)};return window.addEventListener("mousedown",n),e&&e.addEventListener("mousedown",n),o}),[t,s]);const u=e.useRef(a),d=e.useRef(n),p=e.useRef(i);return e.useEffect((()=>{u.current=a,d.current=n,p.current=i}),[a,n,i]),e.useEffect((()=>{if(!s.audioReady||l)return void s.pauseAudio();let e=!1;return(async()=>{if(await new Promise((e=>setTimeout(e,1))),e)return;const t=await async function(e,t,n,s){if(n.voiceType===o.SYNTHETIC&&"string"==typeof n.syntheticVoice&&s.content){e.ensureIdentified();const o=k(t.data),r=U(s.content,o);return e.getStepSpeech(n.syntheticVoice,r)}if(n.voiceType===o.MANUAL&&s.speechAsset)return s.speechAsset.assetUrl;return null}(s,u.current,d.current,p.current);e||t&&s.playAudio(t)})(),()=>{e=!0}}),[l,s,i.id,n.voiceType,n.syntheticVoice]),null};const Y=e.forwardRef(((t,o)=>{const n=I();return e.createElement("div",{ref:o,className:"userflowjs-out-of-viewport-pointer",style:{zIndex:n+2}},e.createElement(P,{icon:D}))}));function G(e,t){const o=e.current;o&&(o.classList.toggle("userflowjs-out-of-viewport-pointer--visible",null!=t),t&&(o.style.left=t.left+"px",o.style.top=t.top+"px",o.classList.toggle("userflowjs-out-of-viewport-pointer--visible-up","up"===t.direction),o.classList.toggle("userflowjs-out-of-viewport-pointer--visible-down","down"===t.direction)))}const H=({theme:t})=>{const{step:o}=ae();return e.createElement(e.Fragment,null,o.beacons.map((o=>e.createElement(X,{key:o.id,beacon:o,theme:t}))))},X=({beacon:t,theme:o})=>{const{session:n}=ae(),s=I(),r=e.useRef(null),l=e.useRef(null),a=g(t.hiddenCondition),i=e.useMemo((()=>S(t.selector,n.data)),[t.selector,n.data]),c=e.useCallback((({targetRect:e,clipEl:n,viewportClipRect:s})=>{const a=function({beacon:e,beaconRef:t,clipEl:o,viewportClipRect:n,targetRect:s,theme:r}){if(!t.current)return null;if(0===s.width||0===s.height)return null;const l=r.beaconSize,a=r.beaconSize,i=R(o);let c=0,u=0;switch(e.placement){case"top-left":case"left":case"bottom-left":c=s.left;break;case"top":case"center":case"bottom":c=s.left+s.width/2;break;default:c=s.left+s.width}switch(e.placement){case"left":case"center":case"right":u=s.top+s.height/2;break;case"bottom-left":case"bottom":case"bottom-right":u=s.top+s.height;break;default:u=s.top}c-=l/2,u-=a/2,c+=e.offsetX,u+=e.offsetY,c=Math.max(c,i.left-(o===document.documentElement?0:o.scrollLeft)),u=Math.max(u,i.top-(o===document.documentElement?0:o.scrollTop));const d=c+l,p=u+a,m=Math.min(32,.5*a);let f;f=p<n.top+m?"up":u>n.bottom-m?"down":null;return{top:u,right:d,bottom:p,left:c,width:l,height:a,pointerSubjectPosition:{direction:f,left:c,width:l},visible:null==f}}({beacon:t,beaconRef:r,clipEl:n,viewportClipRect:s,targetRect:e,theme:o}),i=a&&function({subjectPosition:e,pointerRef:t,viewportClipRect:o}){const n=t.current;if(!n)return null;const s=n.getBoundingClientRect(),r=j(T());let l,a,i=e.direction;return null==i?null:("down"===i&&o.bottom<s.height/2?i="up":"up"===i&&o.top>r&&(i="down"),l=e.left+e.width/2-s.width/2,a="down"===i?o.bottom-s.height:o.top,{direction:i,left:l,top:a})}({subjectPosition:a.pointerSubjectPosition,pointerRef:l,viewportClipRect:s});C((()=>{K(r,a),G(l,i)}))}),[t]),u=e.useCallback((()=>{K(r,null),G(l,null)}),[]);return F({selector:a?null:i,targetMoved:c,targetLost:u}),e.createElement(e.Fragment,null,e.createElement("div",{ref:r,className:"userflowjs-beacon userflowjs-beacon--pulse userflowjs-beacon--for-flow userflowjs-fixed-widget",style:{zIndex:s+2}},e.createElement("div",{className:"userflowjs-beacon__ring"}),e.createElement("div",{className:"userflowjs-beacon__ring"})),e.createElement(Y,{ref:l}))};function K(e,t){const o=e.current;o&&(o.classList.toggle("userflowjs-fixed-widget--visible",null!=t),t&&(o.style.transform=`translate3d(${t.left}px, ${t.top}px, 0)`,o.style.visibility=t.visible?"visible":"hidden"))}const W=()=>{const{t:o}=_(),n=L(),{restart:l}=le(),{session:a,step:i}=ae(),c=i.theme||a.version.theme,u=i.selector,d=!u||u.type===s.AUTO&&!u.autoData,m=()=>n.endFlow(a,{endReason:t.USER_CLOSED});return e.createElement(e.Fragment,null,e.createElement(p,{draftMode:a.draftMode,close:m}),a.draftMode&&d?e.createElement("div",{className:"userflowjs-bubble-content"},e.createElement("div",{className:"userflowjs-bubble-alert p-like"},e.createElement("span",{className:"userflowjs-bubble-alert__label"},"Preview-only tip"),"No tooltip target selected yet. Please go back to the Builder and select a tooltip target in ",e.createElement("b",null,"Step ",i.idx+1)," of"," ",e.createElement("b",null,a.flow.name),".")):a.draftMode&&c.tooltipMissingBehavior===r.END?e.createElement("div",{className:"userflowjs-bubble-content"},e.createElement("div",{className:"userflowjs-bubble-alert p-like"},e.createElement("p",null,e.createElement("span",{className:"userflowjs-bubble-alert__label"},"Preview-only tip"),"The tooltip target element in ",e.createElement("b",null,"Step ",i.idx+1)," of"," ",e.createElement("b",null,a.flow.name)," was not found within"," ",c.tooltipMissingToleranceSeconds," ",1===parseFloat(c.tooltipMissingToleranceSeconds)?"second":"seconds","."),e.createElement("p",null,"For regular users, the flow will auto-dismiss when this happens."),e.createElement("p",null,"If you are on the right page, then try reselecting the element in the Builder."),e.createElement("p",null,"Read more in our"," ",e.createElement("a",{href:"https://userflow.com/docs/trouble/element-not-found",target:"_blank",rel:"noopener noreferrer"},"Element not found guide"),"."))):e.createElement(e.Fragment,null,e.createElement("div",{className:"userflowjs-bubble-content"},a.draftMode&&e.createElement("div",{className:"userflowjs-bubble-alert p-like"},e.createElement("span",{className:"userflowjs-bubble-alert__label"},"Preview-only tip"),"The tooltip target element in ",e.createElement("b",null,"Step ",i.idx+1)," of"," ",e.createElement("b",null,a.flow.name)," was not found on the page. If you are on the right page, then try reselecting the element in the Builder."),e.createElement("p",null,e.createElement("b",null,o("tooltipTargetMissing.line1"))),e.createElement("p",null,o("tooltipTargetMissing.line2"))),e.createElement("div",{className:"userflowjs-bubble-buttons"},e.createElement(E,{appearance:"primary",onClick:l,text:o("menu.restart")}),e.createElement(E,{appearance:"default",onClick:m,text:o("menu.close")}))))},$=({session:o,checklistSession:n,resourceCenterEmbedsChecklist:s})=>{const d=L(),[p,m]=e.useState(!1),[f,b]=e.useState(null),[h,w]=e.useReducer(Z,void 0,(()=>{const e=o,t=ee(e);return{...Q,session:e,step:t,muted:!!l.getItem("flowsMuted"),autoFocusRequested:oe(t)}})),{session:g,step:E,speechPlaying:k,contentType:j}=h,{version:T}=g,R=ne(E);let F=0;E.questions.some((e=>e.type===i.NPS))&&(F=420);const C=B(E.theme||T.theme),I=e.useMemo((()=>{let e=C.bubbleY;const t=n?.version.theme;return!s&&n&&t&&n.version.checklist?.launcherEnabled&&E.appearance===a.BUBBLE&&t.checklistLauncherPlacement===C.bubblePlacement&&(C.avatarType===c.NONE||t.checklistLauncherX<C.bubbleX+C.avatarSize)&&(e=Math.max(C.bubbleY,t.checklistLauncherY+t.checklistLauncherHeight+C.bubbleY)),{...C,bubbleWidth:Math.max(C.bubbleWidth,F),bubbleY:e}}),[s,n,E.appearance,C,F]);e.useEffect((()=>{g!==o&&w({kind:"updateSession",session:o});const e=e=>{e.session.id===g.id&&w({kind:"goToStep",stepId:e.step.id})};return d.on("gotostep",e),()=>{d.off("gotostep",e)}}),[d,g,o]);const D=e.useMemo((()=>({dispatch:w,restart:()=>{d.goToStep(g,te(g)),w({kind:"showFlow"})}})),[d,w,g]),P=e.useMemo((()=>E.selector&&S(E.selector,g.data)),[E.selector,g.data]),q=e.useCallback((()=>{v(d,g,E.actions)}),[d,g,E.actions]);e.useEffect((()=>{h.muted?l.setItem("flowsMuted","true"):l.removeItem("flowsMuted")}),[h.muted]);const _=g.locale?g.locale.standardLocaleId:I.languageId;e.useEffect((()=>{M.changeLanguage(_)}),[_]);const[O,U]=e.useState(!1),z=e.useCallback((e=>{U(e),e&&d.send({kind:"ReportTooltipTargetMissing",sessionId:g.id,stepId:E.id}),e&&I.tooltipMissingBehavior===r.END&&!g.draftMode&&d.endFlow(g,{endReason:t.TOOLTIP_TARGET_MISSING})}),[d,g,E.id,I.tooltipMissingBehavior]);return e.useEffect((()=>{if(!p||!h.autoFocusRequested)return;d.originalActiveElement||d.originalActiveElement===f?.ownerDocument.defaultView?.frameElement||(d.originalActiveElement=document.activeElement);let e=f?.querySelector('button:not([tabindex="-1"]):not(.userflowjs-bubble-toolbar-button), [tabindex]:not([tabindex="-1"]):not(.userflowjs-bubble-toolbar-button), input, textarea');if(e&&e.matches(".userflowjs-bubble-buttons button:not(.userflowjs-bubble-button--primary)")){const t=f?.querySelector(".userflowjs-bubble-buttons .userflowjs-bubble-button--primary");t&&(e=t)}e&&"function"==typeof e.focus&&e.focus({preventScroll:!0}),w({kind:"autoFocused"})}),[d,f,p,h.autoFocusRequested]),e.useEffect((()=>{const e=f?.ownerDocument.defaultView;if(!e)return;const t=()=>{w({kind:"focusOut"}),delete d.originalActiveElement},o=()=>{w({kind:"focusIn"})};return window.addEventListener("focusin",t),e.addEventListener("focusin",o),()=>{window.removeEventListener("focusin",t),e.removeEventListener("focusin",o)}}),[f,d]),e.useEffect((()=>{if(!R||!f)return;const e=f.ownerDocument.defaultView,o=e?e.document:document,n=e=>{if("Escape"!==e.key||T.closeDisabled){if("Tab"===e.key){const t=f.querySelectorAll('button:not([tabindex="-1"]), [tabindex]:not([tabindex="-1"]), input, textarea'),n=t[0],s=t[t.length-1],r=o.activeElement;e.shiftKey?r===n&&(e.preventDefault(),s.focus()):r===s&&(e.preventDefault(),n.focus())}}else d.endFlow(g,{endReason:t.USER_CLOSED})};return window.addEventListener("keydown",n),e?.addEventListener("keydown",n),()=>{window.removeEventListener("keydown",n),e?.removeEventListener("keydown",n)}}),[R,d,g,f,T.closeDisabled]),e.useEffect((()=>{if(h.scrollToTopRequested){if(f?.ownerDocument.defaultView?.frameElement){const e=f?.ownerDocument.body;e&&(e.scrollTop=0)}w({kind:"scrolledToTop"})}}),[h.scrollToTopRequested,f]),e.createElement(se.Provider,{value:D},e.createElement(re.Provider,{value:h},e.createElement(y.Provider,{value:g},e.createElement(N,null,e.createElement(x,{company:g.flow.company,theme:I,position:"fixed",stepKey:E.crossVersionId,stepAppearance:E.appearance,width:E.width,backgroundImageUrl:"flow"===j&&!O&&E.backgroundAsset?E.backgroundAsset.assetUrl:null,tooltipSelector:P,tooltipPlacement:E.tooltipPlacement,backdrop:E.backdrop,tooltipTargetBlocked:E.tooltipTargetBlocked,backdropPadding:E.backdropPadding,onTooltipTargetClick:q,onTooltipTargetMissingChange:z,onModalBackdropClick:E.appearance!==a.MODAL||I.modalBackdropOnclick!==u.DISMISS||T.closeDisabled?void 0:()=>d.endFlow(g,{endReason:t.USER_CLOSED}),speaking:k,minimizeOnAvatarClick:!0,autoHide3pEnabled:!0,onVisibleChange:m,bubbleFrameRootRef:b,rootChildren:t=>e.createElement(J,{...t,theme:I})},"menu"===j?e.createElement(A,null):O&&I.tooltipMissingBehavior!==r.BUBBLE?e.createElement(W,null):e.createElement(V,{theme:I}))))))},J=({visible:t,bubbleFrame:o,theme:n})=>{const s=ae(),{step:r}=s,l=s.session.currentStep&&s.session.currentStep.id,[a,i]=e.useState(!1),c=e.useRef(l);return e.useEffect((()=>{t?i(!0):c.current!==l&&i(!1),c.current=l}),[l,t]),e.createElement(e.Fragment,null,(t||a)&&"flow"===s.contentType&&e.createElement(e.Fragment,null,e.createElement(z,{bubbleFrame:o,theme:n}),e.createElement(H,{theme:n})),r.triggers.map((t=>e.createElement(q,{key:t.id,trigger:t}))))},Q={muted:!1,speechPlaying:!1,contentType:"flow",autoFocusRequested:!1,hasFocus:!1,scrollToTopRequested:!1,shouldLabelDialog:!0};function Z(e,t){switch(t.kind){case"updateSession":{let o;return o=t.session.id===e.session.id&&t.session.version.steps.find((({crossVersionId:t})=>t===e.step.crossVersionId))||ee(t.session),{...e,session:t.session,step:o}}case"goToStep":{const o=e.session.version.steps.find((e=>e.id===t.stepId));return o?{...e,step:o,contentType:"flow",autoFocusRequested:e.hasFocus||oe(o),scrollToTopRequested:!0,shouldLabelDialog:!e.hasFocus}:e}case"toggleMuted":return{...e,muted:!e.muted};case"speechPlaying":return{...e,speechPlaying:!0};case"speechStopped":return{...e,speechPlaying:!1};case"showFlow":return{...e,contentType:"flow",autoFocusRequested:!0,scrollToTopRequested:!0};case"showMenu":return{...e,contentType:"menu",autoFocusRequested:!0,scrollToTopRequested:!0};case"autoFocused":return{...e,autoFocusRequested:!1};case"focusIn":return{...e,hasFocus:!0};case"focusOut":return{...e,hasFocus:!1};case"scrolledToTop":return{...e,scrollToTopRequested:!1}}}function ee(e){const{currentStep:t}=e,{steps:o}=e.version;if(t){const e=o.find((({crossVersionId:e})=>e===t.crossVersionId));if(!e)throw new d("Session points to an unknown step: "+t.crossVersionId);return e}return te(e)}function te(e){const t=e.version.steps[0];if(!t)throw new d("Session has no current step and its version has no start step");return t}function oe(e){return ne(e)}function ne(e){return e.appearance===a.MODAL||e.appearance===a.BUBBLE&&e.backdrop||e.appearance===a.TOOLTIP&&e.tooltipTargetBlocked}const se=e.createContext(null),re=e.createContext(null);function le(){return e.useContext(se)}function ae(){return e.useContext(re)}export default $;export{$ as FlowApp,re as FlowStateContext,Q as initialFlowState,ne as isStepModal,le as useFlowDispatch,ae as useFlowState};
