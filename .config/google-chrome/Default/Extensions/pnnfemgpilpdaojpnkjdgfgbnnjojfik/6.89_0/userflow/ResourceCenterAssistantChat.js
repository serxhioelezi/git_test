import{r as e}from"./vendor.react.js";import{$ as t,a0 as s,i as a}from"./userflow.js";import{u as n}from"./client-context.js";import{D as r,E as o,F as i,G as c,H as l,I as u,J as m,K as d}from"./vendor.fortawesome.pro-regular-svg-icons.js";import{p as g}from"./vendor.dompurify.js";import{m as f}from"./vendor.marked.js";import{o as p}from"./vendor.obj-str.js";import{A as b,d as h,G as k}from"./ResourceCenterApp.js";import{r as E,R as _}from"./bubble-frame.styl.js";import{D as j}from"./stylesheets.js";import{U as v,b as w}from"./flow-condition-types.js";import{r as C}from"./vendor.react-dom.js";import{u as I}from"./vendor.react-i18next.js";import"./vendor.object-assign.js";import"./vendor.phoenix.js";import"./vendor.uuid.js";import"./vendor.i18next.js";import"./flow-host.styl.js";import"./use-window-resize.js";import"./logomark.js";import"./ChecklistUI.js";import"./vendor.fortawesome.pro-solid-svg-icons.js";import"./BubbleToolbar.js";import"./use-element-rect.js";import"./vendor.date-fns.js";import"./vendor.scheduler.js";import"./vendor.babel.runtime.js";function S(e){const t=Intl.Segmenter;if(t){return/(\p{Emoji_Presentation}|\p{Extended_Pictographic})(\p{Emoji_Modifier_Base}?\p{Emoji_Modifier}?|\uFE0F\u200D(\p{Emoji_Modifier_Base}\p{Emoji_Modifier}?\uFE0F\u200D)*\p{Emoji_Presentation}|\uFE0F\u200D\p{Extended_Pictographic})/u.test(e)&&1===[...(new t).segment(e)].length}return!1}const M=[];const R=({assistant:t,lookupAttribute:s,history:a,setInput:n,contentElRef:r,scrolledToTop:o,userContent:i,setUserContent:c,onSubmitMessage:l,supportsFeedback:u,onSubmitRating:m,onSubmitFeedback:d,InsideMessage:g,onContactClick:f,contactButtonText:h,reset:k,onContentScroll:j,onContentWheel:v,conversationId:w})=>{const C=a.some((e=>e.completed||e.failed));return e.createElement("div",{className:"userflowjs-assistant-chat"},e.createElement("div",{className:p({"userflowjs-assistant-chat__header":!0,"userflowjs-assistant-chat__header--content-scrolled":!o})},e.createElement("h2",{className:"userflowjs-assistant-chat__title"},t.title),e.createElement("button",{className:"userflowjs-bubble-button userflowjs-bubble-button--default",onClick:k},t.resetText)),e.createElement("div",{ref:r,className:"userflowjs-assistant-chat__content",onScroll:j,onWheel:v},!E(t.intro)&&e.createElement("div",{className:"userflowjs-assistant-chat__intro"},e.createElement(_,{doc:t.intro,lookupAttribute:s})),a.map(((s,n)=>e.createElement(N,{key:n,assistant:t,message:s,supportsFeedback:u,onSubmitRating:m,onSubmitFeedback:d,InsideMessage:g,conversationId:w,isLast:n===a.length-1})))),e.createElement("div",{className:"userflowjs-assistant-chat__prompt"},e.createElement(b,{textareaRef:n,placeholder:(0===a.length?t.promptEmptyPlaceholder:t.promptNonemptyPlaceholder)||"",value:i,onChange:c,onSubmit:()=>l(i)})),C&&f&&e.createElement("div",{className:"userflowjs-assistant-chat__contact"},e.createElement("button",{className:"userflowjs-tertiary-button",onClick:()=>f()},h)))},N=({assistant:s,message:a,supportsFeedback:n,onSubmitRating:r,onSubmitFeedback:o,InsideMessage:i,conversationId:c,isLast:l})=>e.createElement("div",{className:"userflowjs-assistant-chat__message"},i&&e.createElement(i,{message:a}),e.createElement("div",{className:p({"userflowjs-assistant-chat__user-content":!0,"userflowjs-assistant-chat__user-content--enter":!!a.enterAnimation}),"data-assistant-conversation-id":c,"data-assistant-message-id":a.id},e.createElement("div",{style:{whiteSpace:"pre-wrap"}},a.userContent)),a.warning&&e.createElement("div",{className:"userflowjs-assistant-chat__error"},"Warning: ",a.warning),e.createElement("div",{className:"userflowjs-assistant-chat__assistant-content"},e.createElement("div",null,e.createElement(F,{html:a.assistantHtml})),a.error&&e.createElement("div",{className:"userflowjs-assistant-chat__error"},a.error)),a.sources&&a.sources.length>0&&e.createElement("div",{className:"userflowjs-assistant-chat__sources"},e.createElement("div",{className:"userflowjs-assistant-chat__sources-title"},s.sourcesText),a.sources.map(((t,s)=>e.createElement("a",{key:s,className:"userflowjs-assistant-chat__source",href:h(t.url),target:"_blank",rel:"noreferrer noopener"},t.title)))),n&&a.completed&&a.id&&(s.ratingMode===t.LIKE||s.ratingMode===t.SCALE&&l)&&e.createElement(x,{assistant:s,message:a,onSubmitRating:r,onSubmitFeedback:o})),x=({assistant:a,message:n,onSubmitRating:c,onSubmitFeedback:l})=>{const u=e.useRef(null),[m,d]=e.useState(""),g=()=>{n.id&&(l({messageId:n.id,feedback:m.trim()}),d(""))},f=a.ratingMode===t.LIKE?e.createElement("button",{className:"userflowjs-assistant-chat__rating-option",disabled:!0},e.createElement(j,{icon:n.rating==s.DISLIKE?r:o})):n.scaleRating&&n.scaleMax&&e.createElement("button",{className:p({"userflowjs-assistant-chat__rating-option":!0,"userflowjs-assistant-chat__rating-option--scale":!0}),disabled:!0},H(a,n.scaleRating,n.scaleMax));return e.createElement("div",{className:`userflowjs-assistant-chat__rating userflowjs-assistant-chat__rating--${a.ratingMode}`},a.ratingMode===t.SCALE&&e.createElement("div",{className:"userflowjs-assistant-chat__rating-question"},a.scaleQuestion),n.feedbackSubmitted?e.createElement("div",{className:"userflowjs-assistant-chat__rating-thanks"},f,e.createElement("div",{className:"userflowjs-assistant-chat__rating-thanks-message"},a.feedbackThanksText)):(a.ratingMode===t.LIKE?n.rating:n.scaleRating)?e.createElement(k,{textareaRef:u,className:"userflowjs-growing-textarea userflowjs-assistant-chat__feedback-textarea",mirrorClassName:"userflowjs-growing-textarea__mirror",textareaClassName:"userflowjs-textarea",placeholder:(a.ratingMode===t.LIKE?n.rating===s.LIKE?a.feedbackLikePlaceholder:a.feedbackDislikePlaceholder:a.scaleFeedbackPlaceholder)||"",value:m,onChange:d,onKeyDown:e=>{e.shiftKey||"Enter"!==e.key||(e.preventDefault(),g())}},f,e.createElement("button",{className:"userflowjs-assistant-chat__feedback-submit",onClick:()=>g()},e.createElement(j,{icon:i}))):e.createElement("div",{className:"userflowjs-assistant-chat__rating-options"},a.ratingMode===t.LIKE?[s.LIKE,s.DISLIKE].map((a=>(!n.rating||n.rating===a)&&e.createElement("button",{key:a,className:"userflowjs-assistant-chat__rating-option",onClick:n.rating?void 0:()=>(e=>{const s=n.id;s&&(C.flushSync((()=>{c({ratingMode:t.LIKE,messageId:s,rating:e})})),u.current?.focus({preventScroll:!0}))})(a),disabled:!!n.rating,"data-testid":`assistant-chat-rating-${a}`},e.createElement(j,{icon:a==s.DISLIKE?r:o})))):function(e){let t=[];const s=e.scaleMax||5;for(let a=1;a<=s;a++)t.push({value:a,label:H(e,a,s)});return t}(a).map((({value:s,label:r})=>e.createElement("button",{key:s,className:p({"userflowjs-assistant-chat__rating-option":!0,"userflowjs-assistant-chat__rating-option--large-scale":S(r||"")}),onClick:n.scaleRating?void 0:()=>(e=>{const s=n.id;s&&(C.flushSync((()=>{c({ratingMode:t.SCALE,messageId:s,scaleRating:e,scaleMax:a.scaleMax})})),u.current?.focus({preventScroll:!0}))})(s),disabled:!!n.scaleRating,"data-testid":`assistant-chat-rating-${s}`},r)))))};function y(e){let t=e;const s=e=>e=(e=e.replace(/\s*[*_`]*$/,"")).replace(/(^|\n)\s*(\d+\.?|-|=)$/,"");t=s(t),t=t.replace(/\[([^\]\n]*)(\](\([^)\n]*)?)?$/,"$1"),t=s(t);const a=Array.from(t.matchAll(/\n( *)```/g));if(a.length%2==1){t+="\n"+a[a.length-1][1]+"```"}else{let e=0;for(let r=t.length-1;r>=0;r--)if("\n"===t[r]&&"\n"===t[r-1]){e=r;break}const s=[];let a=!1;const n=e=>null==e||e.match(/\W/);for(let r=e;r<t.length;r++){const o=t[r],i=o+t[r+1],c=i+t[r+2];let l=null;if((a||"***"!==c)&&(a||"___"!==c||!n(t[r-1])&&!n(t[r+3]))?(a||"**"!==i)&&(a||"__"!==i||!n(t[r-1])&&!n(t[r+2]))?(a||"*"!==o)&&(a||"_"!==o||!n(t[r-1])&&!n(t[r+1]))?"`"===o&&(l=o):l=o:l=i:l=c,null!=l){!!t.slice(e,r+l.length).match(/\[[^\]\n]*\]\([^)\n]*$/)||(s[s.length-1]===l?("`"===l&&(a=!1),s.pop()):("`"===l&&(a=!0),s.push(l))),r+=l.length-1}}t+=s.reverse().join("")}return t}function A(e,t){e=e.trim(),!1!==t&&(e=e.replace(/(\n *```)?$/," {{USERFLOWCHATBRAIN}}$1"));let s=g.sanitize(f.parse(e));if(!1!==t){let e="userflowjs-assistant-brain";t&&(e+=` userflowjs-assistant-brain--${t}`),s=s.replace("{{USERFLOWCHATBRAIN}}",`<span class="${e}"><span></span><span></span><span></span><span></span></span>`)}return s=s.replace(/<a href=/g,'<a target="_blank" rel="noopener noreferrer" href='),s}const F=({html:t})=>e.useMemo((()=>{if(!t)return null;return L((new DOMParser).parseFromString(t,"text/html").body)}),[t]);function L(t,s){if(t instanceof Element){if("BODY"===t.tagName)return e.createElement(e.Fragment,{key:s},T(t));{if(["script","style"].includes(t.tagName))return null;const a={key:s};for(const e of t.attributes){let t=e.name;t.startsWith("on")||("class"===t&&(t="className"),a[t]=e.value)}return e.createElement(t.tagName.toLowerCase(),a,T(t))}}return t instanceof Text?t.textContent:null}function T(e){const t=[];let s=0;for(const a of e.childNodes)t.push(L(a,s)),s++;return t}function H(t,s,a){if(t.scaleLabels)return t.scaleLabels[s-1]||s;{const t=K[a]&&K[a][s];return t?e.createElement(j,{icon:t,size:24}):s}}const K={2:{1:c,2:l},3:{1:c,2:u,3:l},4:{1:m,2:c,3:l,4:d},5:{1:m,2:c,3:u,4:l,5:d}},D=({block:s,session:r,assistantReply:o,initialUserContent:i,onContactClick:c,contactButtonText:l})=>{const u=s.assistantFlowId,m=n(),{t:d}=I(),g=d("assistant.generic_error"),f=d("assistant.disconnected_error"),p=function({assistant:s,lookupAttribute:a,initialConversationId:n,initialHistory:r,initialUserContent:o,onConversationIdChange:i,submitMessage:c,submitRating:l,submitFeedback:u,InsideMessage:m,onContactClick:d,contactButtonText:g}){const[f,p]=e.useState(null),[b,h]=e.useState((()=>r?r.map((e=>({...e,assistantHtml:A(y(e.assistantContent),!1)}))):M)),[k,E]=e.useState(""),_=e.useRef(null),j=e.useRef(null),w=e.useRef(!0),C=e.useRef(n||null),[I,S]=e.useState(C.current),R=e.useCallback((e=>{C.current=e,S(e),i&&i(e)}),[i]),N=e.useCallback((()=>{f?.focus({preventScroll:!0})}),[f]);e.useEffect((()=>{N()}),[N]),e.useLayoutEffect((()=>{const e=j.current;e&&(e.scrollTop=Math.ceil(e.scrollHeight-e.clientHeight))}),[]);const x=e.useCallback((()=>{const e=j.current;e&&(w.current=!0,"function"==typeof e.scrollTo&&e.scrollTo({top:Math.ceil(e.scrollHeight-e.clientHeight),behavior:"smooth"}))}),[]),F=e.useRef(0);e.useLayoutEffect((()=>{const e=j.current;e&&e.scrollHeight!==F.current&&(F.current=e.scrollHeight,w.current&&x())}),[b,x]);const L=e.useCallback((()=>{_.current&&_.current()}),[]);e.useEffect((()=>()=>{L()}),[L]);const T=(e,t)=>{h((s=>s.map((s=>{if(e===s.id){const e=t(s);return{...s,...e}}return s}))))},H=e=>{h((t=>t.map(((s,a)=>{if(a===t.length-1){const t=e(s);return{...s,...t}}return s}))))},K=e.useCallback((async e=>{if(""===(e=e.trim()))return;L(),h((t=>[...t,{id:null,userContent:e,assistantContent:"",assistantHtml:A("","enter"),enterAnimation:!0,sources:[],completed:!1,rating:null,scaleRating:null,scaleMax:null,feedbackSubmitted:!1}])),E(""),x();let t=!1;const s=()=>{t=!0,_.current=null},a=c({conversationId:C.current,userContent:e,callback:e=>{if(t)console.log("Userflow.js AssistantChat got message after being done",e);else switch(e.kind){case"conversation_created":R(e.conversationId);break;case"message_created":H((()=>({id:e.messageId,warning:e.warning})));break;case"assistant_content_delta":H((t=>{const s=e.delta,a=t.assistantContent+s;return{assistantContent:a,assistantHtml:A(y(a))}}));break;case"done":s(),H((t=>({assistantHtml:A(t.assistantContent,"exit"),completed:!0,sources:e.sources})));break;case"error":s(),H((t=>({failed:!0,error:e.message,assistantHtml:A(y(t.assistantContent),!1)})));break;default:console.log("Userflow.js AssistantChat got unknown message",e)}}});_.current=()=>{s(),a.abort(),H((e=>({assistantHtml:A(y(e.assistantContent),!1)})))}}),[L,x,c,R]),D=e.useRef(!1);e.useEffect((()=>{D.current||(D.current=!0,o&&K(o))}),[K,o]);const $=e.useCallback((()=>{L(),R(null),h(M),N()}),[L,N,R]),[P,B]=e.useState(!0),U=e.useCallback((()=>{const e=j.current;e&&B(0===e.scrollTop)}),[]),W=e.useCallback((()=>{const e=j.current;e&&(w.current=Math.ceil(e.scrollHeight-e.clientHeight)==Math.ceil(e.scrollTop))}),[]);return{assistant:s,lookupAttribute:a,history:b,setInput:p,contentElRef:j,scrolledToTop:P,userContent:k,setUserContent:E,onSubmitMessage:K,supportsFeedback:!!l&&!!u,onSubmitRating:e=>{if(l){switch(e.ratingMode){case t.LIKE:T(e.messageId,(()=>({rating:e.rating})));break;case t.SCALE:T(e.messageId,(()=>({scaleRating:e.scaleRating,scaleMax:e.scaleMax})));break;default:throw new v(e)}l(e)}},onSubmitFeedback:e=>{u&&(T(e.messageId,(()=>({feedbackSubmitted:!0}))),u(e))},InsideMessage:m,onContactClick:d,contactButtonText:g,reset:$,onContentScroll:U,onContentWheel:W,conversationId:I}}(e.useMemo((()=>({assistant:o.assistant,lookupAttribute:w(r.data),initialConversationId:o.conversationId,initialHistory:o.history,initialUserContent:i,onConversationIdChange:e=>{const t="assistantConversationId:"+u;e?a.setItem(t,e):a.removeItem(t)},submitMessage:({conversationId:e,userContent:t,callback:s})=>{m.assistantMessageInProgress=!0;const a=m.nextRef();m.send({kind:"SubmitAssistantMessage",ref:a,assistantFlowId:u,conversationId:e,userContent:t},{handlesRejection:!0}).catch((e=>{s({kind:"error",message:e.humanMessage||g})}));const n=()=>{m.assistantMessageInProgress=void 0,m.off("private:assistantMessageEvent",r),m.off("private:disconnect",o)},r=e=>{if(e.ref!==a)return;const{event:t}=e;s(t),"done"!=t.kind&&"error"!=t.kind||n()},o=()=>{s({kind:"error",message:f}),n()};return m.on("private:assistantMessageEvent",r),m.on("private:disconnect",o),{abort:()=>{m.send({kind:"AbortAssistantMessage"}),n()}}},submitRating:e=>{switch(e.ratingMode){case t.LIKE:m.send({kind:"SubmitAssistantRating",messageId:e.messageId,rating:e.rating});break;case t.SCALE:m.send({kind:"SubmitAssistantScaleRating",messageId:e.messageId,scaleRating:e.scaleRating,scaleMax:e.scaleMax});break;default:throw new v(e)}},submitFeedback:e=>{m.send({kind:"SubmitAssistantFeedback",messageId:e.messageId,feedback:e.feedback})},onContactClick:c,contactButtonText:l})),[o,u,m,i,r.data,c,l,g,f]));return e.createElement(e.Fragment,null,e.createElement(R,{...p}))};export{D as ResourceCenterAssistantChat};
