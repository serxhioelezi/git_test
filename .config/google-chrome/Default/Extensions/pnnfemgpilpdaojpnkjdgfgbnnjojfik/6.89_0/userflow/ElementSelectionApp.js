import{r as e}from"./vendor.react.js";import{i as t}from"./vendor.is-hotkey.js";import{o as n}from"./vendor.obj-str.js";import{r as o,g as s,a,l as r,m as l,n as i,k as m,e as c,p as d,q as u,s as p}from"./flow-condition-types.js";import{a as v}from"./userflow.js";import{u as f}from"./client-context.js";import{u as g}from"./use-window-resize.js";import{B as w}from"./BuilderBar.js";import"./vendor.object-assign.js";import"./vendor.date-fns.js";import"./vendor.phoenix.js";import"./vendor.uuid.js";import"./vendor.i18next.js";import"./vendor.react-i18next.js";import"./vendor.babel.runtime.js";import"./vendor.react-dom.js";import"./vendor.scheduler.js";import"./stylesheets.js";import"./vendor.fortawesome.pro-regular-svg-icons.js";import"./vendor.fortawesome.pro-solid-svg-icons.js";import"./logomark.js";import"./vendor.fortawesome.pro-light-svg-icons.js";const h=t("alt+s"),b=t("escape"),y=t("u"),E=({state:t})=>{const{mode:c,elementType:d}=t,E=f(),L=e.useRef(null),[S,N]=e.useState(!1),M=e.useRef(null),[k,R]=e.useState(null),[D,F]=e.useState((()=>x())),T=e.useCallback((async(e,t)=>{if(e&&t){const n=L.current?.getFrame();n&&M.current&&(M.current.classList.add("userflowjs-element-selection-box--no-transition"),n.style.display="none",n.offsetWidth),m(),E.setSessionStorageState((e=>({...e,elementSelection:{...e.elementSelection,mode:"done"}})));const l=o(e),i=0,c=0,d=Math.round(s()),u=Math.round(a()),p=await E.getTargetEnv().captureScreenshot(i,c,d,u),v=e=>Math.round(e/r(1));t={...t,screenshotDataUrl:p,targetX1:v(l.left),targetY1:v(l.top-c),targetX2:v(l.right),targetY2:v(l.bottom-c),screenshotWidth:d,screenshotHeight:u}}E.setSessionStorageState((e=>({...e,activeApp:null,elementSelection:null}))),E.getTargetEnv().postBuilderMessage({kind:"userflow:selectElementResult",selectorData:t})}),[E]),A=e.useCallback((e=>E.setSessionStorageState((t=>({...t,elementSelection:{...t.elementSelection,mode:e}})))),[E]);return e.useEffect((()=>{if(!S||!L.current)return;const e=L.current.getFrame(),t=L.current.getRootEl();let n=t&&t.ownerDocument&&t.ownerDocument.defaultView;n===window&&(n=null);let f=null,g=null,w=null,E=null;const x=document.getElementById("userflow-ui"),N={capture:!0},k=()=>{window.cancelAnimationFrame(F);let e=null,t=null,n=null;if(g&&!x.contains(g)){let o=null,s=g;for(;s;){{const e=s.getBoundingClientRect();if(0===e.width&&0===e.height){s=j(s);continue}}if(o=u(s,{elementType:d}),o)break;s=j(s)}o?(t=o.el,e=o.selector):n=d===v.INPUT?"No text input found here":"Sorry, we can't select that element (yet!)"}w=t,f=e,R(n),C()};let F;const B=()=>{window.cancelAnimationFrame(F),F=window.requestAnimationFrame(k)},C=()=>{window.cancelAnimationFrame($);const e=M.current;if(!e)return;m();const t=r(s()),n=r(a());let l=n/2,i=t/2,c=n/2,d=t/2;let u=2,v=2,f=2,g=2;if(w){const e=o(w),s=window.getComputedStyle(w);l=Math.max(0,e.top),i=Math.max(0,t-e.right),c=Math.max(0,n-e.bottom),d=Math.max(0,e.left),u=Math.max(2,p(s.borderTopLeftRadius)),v=Math.max(2,p(s.borderTopRightRadius)),f=Math.max(2,p(s.borderBottomLeftRadius)),g=Math.max(2,p(s.borderBottomRightRadius)),E=w}else if(E){const e=o(E);l=Math.max(0,e.top+e.height/2),i=Math.max(0,t-e.right+e.width/2),c=Math.max(0,n-e.bottom+e.height/2),d=Math.max(0,e.left+e.width/2)}e.style.top=`${l}px`,e.style.right=`${i}px`,e.style.bottom=`${c}px`,e.style.left=`${d}px`,e.style.borderTopLeftRadius=`${u}px`,e.style.borderTopRightRadius=`${v}px`,e.style.borderBottomLeftRadius=`${f}px`,e.style.borderBottomRightRadius=`${g}px`,w?document.body.classList.remove("userflowjs-body-with-element-selection--none"):document.body.classList.add("userflowjs-body-with-element-selection--none")};let $;const P=()=>{window.cancelAnimationFrame($),$=window.requestAnimationFrame(C)},I=e=>{if(h(e))return e.preventDefault(),void("select"===c?A("navigate"):"navigate"===c&&A("select"));if(b(e)&&"select"===c)return e.preventDefault(),void T(null,null);if(y(e)&&w){const t=j(w);if(t)return e.preventDefault(),g=t,void k()}},U=e=>{const t=e.composedPath()[0];t&&t!==w&&"BODY"!==t.tagName&&"HTML"!==t.tagName&&(g=t,B())},Y=()=>{g=null,B()};e&&e.addEventListener("mouseenter",Y);const q=e=>{e.preventDefault(),e.stopPropagation()},V=e=>{q(e)},H=e=>{q(e)},O=e=>{if(q(e),D){const t=e.target;if(!w||!w.contains(t))return void U(e)}f&&(T(w,f),X())};n&&n.addEventListener("keydown",I),"select"===c&&(document.body.addEventListener("mouseleave",Y),document.body.classList.add("userflowjs-body-with-element-selection"));const W=l((e=>{const t=e.ownerDocument.defaultView;t&&(t.addEventListener("keydown",I,N),"select"===c&&(t.addEventListener("scroll",P,N),e.addEventListener("mousemove",U,N),e.addEventListener("mousedown",V,N),e.addEventListener("focus",H,N),e.addEventListener("click",O,N)))}),(e=>{const t=e.ownerDocument.defaultView;t&&(t.removeEventListener("keydown",I,N),"select"===c&&(t.removeEventListener("scroll",P,N),i(e)||e.removeEventListener("mousemove",U,N),e.removeEventListener("mousedown",V,N),e.removeEventListener("focus",H,N),e.removeEventListener("click",O,N)))})),X=()=>{window.cancelAnimationFrame(F),window.cancelAnimationFrame($),document.body.removeEventListener("mouseleave",Y),n&&n.removeEventListener("keydown",I),e&&e.removeEventListener("mouseenter",Y),document.body.classList.remove("userflowjs-body-with-element-selection"),document.body.classList.remove("userflowjs-body-with-element-selection--none"),W()};return X}),[D,E,c,S,d,T,A]),g((()=>F(x()))),e.createElement(e.Fragment,null,e.createElement(w,{ref:L,onReadyChange:N,buttons:e.createElement(e.Fragment,null,"navigate"===c?e.createElement("button",{key:"select",className:"btn btn--default",onMouseDown:e=>{e.preventDefault(),e.stopPropagation(),A("select")}},e.createElement("span",{className:"hidden-lg-up"},"Select here"),e.createElement("span",{className:"hidden-md-down"},"Select element here (Alt + S)")):"select"===c?e.createElement("button",{key:"navigate",className:"btn btn--default",onMouseDown:e=>{e.preventDefault(),e.stopPropagation(),A("navigate")}},e.createElement("span",{className:"hidden-lg-up"},"Navigate"),e.createElement("span",{className:"hidden-md-down"},"Navigate to another page (Alt + S)")):null,("select"===c||"navigate"===c)&&e.createElement("button",{className:"btn btn--secondary-on-dark",onClick:()=>T(null,null)},"Cancel"))},"navigate"===c?e.createElement("div",{className:"status"},"Navigate to the page the element appears on"):k?e.createElement("div",{className:"error"},k):e.createElement("div",{className:"status"},D?e.createElement(e.Fragment,null,"Tap"," ",d===v.INPUT?"a text input":"an element"," ","to focus. Tap again to select."):e.createElement(e.Fragment,null,"Click"," ",d===v.INPUT?"a text input":"an element"," ","to select it"))),S&&("select"===c||"done"===c)&&e.createElement("div",{className:n({"userflowjs-element-selection-box":!0}),ref:M}))};function j(e){const t=e.parentNode;if(!t)return null;if(i(t))return t.host;if(!c(t))return null;if("BODY"===t.tagName){const e=d(t);return e||null}return t}function x(){return window.navigator.userAgent.includes("Mobile")}export default E;export{E as ElementSelectionApp};
