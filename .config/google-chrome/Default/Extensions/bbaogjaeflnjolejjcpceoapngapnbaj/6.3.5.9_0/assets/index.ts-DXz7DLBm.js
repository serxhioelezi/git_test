import{q as t,t as e,u as s,v as a,w as r,P as o,S as i,x as n,y as c,z as l,A as u,C as d,E as m,F as p,H as _,I as w,J as E,K as g,L as h,M as I,N as y,O as S,f as T,h as A,D as f,R as b,n as P,o as L,c as R,m as v,j as O,s as U,b as N,e as C,r as k,a as D,B as G,T as H,U as x}from"./bulk-import-products-bJAU--BW.js";import{M as W,r as M,t as F,m as V,B as q,u as B,l as j,h as K,s as Z,v as z,S as $}from"./affiliate-BzdVKAoA.js";import{L as X}from"./link-Chb72h85.js";import{g as Q,p as J}from"./affiliate-Ai0qc8g1.js";import"./_commonjsHelpers-lGe4XDVY.js";const Y=(t,e)=>{const s=(e.except_keyword||"").split(",").map((t=>m(t))).join("|").replace("_","\\s"),a=s&&new RegExp(`(${s.replace(/,/gm,"|")})`,"gim"),r=e.review_option||"all",o=e.rating_option||[1,2,3,4,5];return console.info("--------- start: Filter ---------"),console.table(Object.entries({exceptKeywords:s,reviewOption:r,ratingOption:o,reviews:t})),console.info("--------- end: Filter ---------"),t.filter((t=>{var e,s;let i=!0,n=!0,c=!0;return i=""===a||-1===(null==(e=t.content)?void 0:e.search(a)),"text_photo"===r?n=t.content&&t.img&&t.img.length>0||!1:"text"===r&&(n=t.content&&0===(null==(s=t.img)?void 0:s.length)||!1),c=o.includes(t.star),i&&n&&c}))};var tt=(t=>(t.GET_REVIEW_ALIEXPRESS_PHP="getReviewAliexpressNew",t.GET_REVIEW_ALIEXPRESS_GO="getReviewAliexpressGo",t.GET_REVIEW_AMAZON_GO="getReviewAmazonGo",t.GET_REVIEW_AMAZON_PHP="getReviewAmazonNew",t))(tt||{});const et=async({importTypeStatus:t,cursor:e,shopId:s,rawDomain:a,token:r,importPageType:o})=>{try{const{productsListUrl:i}=await M("productsListUrl"),n=F(i,e,o),{data:c,cursor:l}=await S(n,r),u=await(async(t,e,s,a)=>{try{if(0===e.length)return[];const{data:r}=await T({image_links:e.reduce(((t,e)=>{var s;return(null==e?void 0:e.mainImgUrl)&&(null==(s=null==e?void 0:e.supplier[0])?void 0:s.supplyProductId)&&t.push(e.mainImgUrl),t}),[])},a),o=V(e,Object.values(r),"image").filter((t=>t.id)),{result:i}=await A({product_id_list:o.map((t=>t.id))},a),n=V(o,i,"id").map((t=>({...t,id:+t.id,mainImgUrl:t.image})));return V(e,n,"mainImgUrl").reduce(((e,r,o)=>{const i=r.supplier[0]&&r.supplier[0].supplyProductId||void 0;return r.id&&i&&(t===q.WITHOUT_REVIEWS&&!r.is_reviews||t===q.WITH_REVIEWS&&r.is_reviews||![q.WITHOUT_REVIEWS,q.WITH_REVIEWS].includes(t))&&e.push({aliexpressUrl:`https://www.aliexpress.com/item/${i}.html`,type:f.BULK_GO,productId:r.id,shopId:s,rawDomain:a,expiredTime:B(10*o+1,"minute",new Date),id:r.id}),e}),[])}catch{return[]}})(t,c.products,s,a);return{listImport:u,nextCursor:l}}catch{return{listImport:[],nextCursor:""}}},st=async({importTypeStatus:t,cursor:e,shopId:s,rawDomain:a,token:r,importPageType:o})=>{try{const{productsListUrl:i}=await M("productsListUrl"),n=F(i,e,o),{data:c,cursor:l}=await b(n,r),u=await(async(t,e,s,a)=>{if(0===e.length)return[];const{data:r}=await P(a,{image_links:e.map((t=>t.mainImgUrl))}),o=V(e,Object.values(r),"image").filter((t=>t.id)),{result:i}=await L(a,{product_id_list:o.map((t=>t.id))}),n=V(o,i,"id").map((t=>({...t,id:+t.id,mainImgUrl:t.image,is_reviews:j(Number(t.is_reviews))})));return V(e,n,"mainImgUrl").reduce(((e,r,o)=>{const i=r.supplier[0]&&r.supplier[0].supplyProductId||void 0;return r.id&&i&&(t===q.WITHOUT_REVIEWS&&!r.is_reviews||t===q.WITH_REVIEWS&&r.is_reviews||![q.WITHOUT_REVIEWS,q.WITH_REVIEWS].includes(t))&&e.push({aliexpressUrl:`https://www.aliexpress.com/item/${i}.html`,type:f.BULK_PHP,productId:r.id,shopId:s,rawDomain:a,expiredTime:B(10*o+1,"minute",new Date),id:r.id}),e}),[])})(t,c.products,s,a);return{listImport:u,nextCursor:l}}catch{return{listImport:[],nextCursor:""}}},at=t=>{chrome.tabs.create({url:t})},rt={name:"customScript",path:"src/scripts/custom-script.ts",aliasPath:"@/scripts/custom-script.ts"},ot={name:"operationBanner",path:"src/scripts/operation-banner.ts",aliasPath:"@/scripts/operation-banner.ts"},it=(t,e,s)=>{try{const{tabId:a}=e;chrome.scripting.executeScript({target:{tabId:a},func:nt,args:[t]},(()=>{chrome.runtime.lastError?(console.error("Error in addScriptToDom:",chrome.runtime.lastError.message),s(!1)):s(!0)}))}catch(a){console.error("Error in addScriptToDom:",a),s(!1)}},nt=t=>{try{const e=document.createElement("script");e.src=chrome.runtime.getURL(`/assets/${t.name}.js`),e.type="module",e.onload=()=>console.log(`%cScript loaded: ${t.name}.js`,"background-color: #005bd3; color: #ffffff; border-radius: 5px; font-weight: bold; padding: 4px 10px"),e.onerror=()=>{throw new Error(`Failed to load script: ${t.name}.js`)};const s=document.head||document.documentElement;if(!s)throw new Error("Unable to find target element");s.appendChild(e)}catch(e){console.error("Error injecting script:",e)}},ct=(t={},e)=>new Promise((s=>chrome.tabs.query(t,(t=>{e?e(t):s(t)})))),lt=(t,e={},s=null)=>new Promise((a=>{chrome.tabs.update(t,e,(t=>{s?s(t):a(t)}))}));chrome.runtime.setUninstallURL(X.AFFILIATE_UNINSTALLED_LINK),chrome.runtime.onInstalled.addListener((async t=>{switch(t.reason){case"install":at(X.AFFILIATE_INSTALLED_LINK),Z($.AFFILIATE_OPEN_TAB,!0,30);break;case"update":await(async()=>{at(X.AFFILIATE_UPDATED_LINK),await z($.AFFILIATE_OPEN_TAB)&&Z($.AFFILIATE_OPEN_TAB,!0,1);const t=await z($.AFFILIATE_TIKTOK_OPEN_TAB);t&&"no_key"!==t&&Z($.AFFILIATE_TIKTOK_OPEN_TAB,!0,1)})()}return!0})),chrome.runtime.onMessage.addListener((async t=>{switch(t.message){case R.DSER_SINGLE_GO:await U.enqueue(t.payload);break;case R.DSER_BULK_GO:try{chrome.tabs.query({url:"https://www.dsers.com/*"},(t=>{t.forEach((t=>{t.id&&chrome.tabs.sendMessage(t.id,{isStartImport:!0})}))}));const{importTypeStatus:e,importPageStatus:s,currentSettings:a,shopId:r,rawDomain:o,token:n}=t.payload,c=async t=>{if(C(o,{importPageStatus:s,importTypeStatus:e,settings:a,raw_domain:o,total_import_products:t.length}),!(null==t?void 0:t.length))return chrome.tabs.query({url:"https://www.dsers.com/*"},(t=>{t.forEach((t=>{t.id&&chrome.tabs.sendMessage(t.id,{type:f.BULK_GO,data:{statusCode:i.NO_REVIEWS_MATCH_SETTINGS}})}))})),void(await k(o));let r=[];const n=await U.getQueue();r=t.filter((t=>!n.some((e=>e.id===t.id)))),N.enqueues(r)};switch(s){case K.THIS_PAGE:{const{listImport:t}=await et({importTypeStatus:e,shopId:r,rawDomain:o,token:n,importPageType:K.THIS_PAGE});c(t);break}case K.ALL_PAGES:{let t=!0,s="";const a=[];for(;t;){const i=await et({importTypeStatus:e,cursor:s,shopId:r,rawDomain:o,token:n,importPageType:K.ALL_PAGES});s=i.nextCursor,a.push(...i.listImport),t=!!i.nextCursor}c(a)}}}catch{const{rawDomain:e}=t.payload;k(e)}break;case R.DSER_SINGLE_PHP:await U.enqueue(t.payload);break;case R.DSER_BULK_PHP:try{chrome.tabs.query({url:"https://www.dsers.com/*"},(t=>{t.forEach((t=>{t.id&&chrome.tabs.sendMessage(t.id,{isStartImport:!0})}))}));const{importTypeStatus:e,importPageStatus:s,currentSettings:a,shopId:r,rawDomain:o,token:n}=t.payload,c=async t=>{if(v(o,{importPageStatus:s,importTypeStatus:e,settings:a,raw_domain:o,total_import_products:t.length}),!t.length)return chrome.tabs.query({url:"https://www.dsers.com/*"},(t=>{t.forEach((t=>{t.id&&chrome.tabs.sendMessage(t.id,{type:f.BULK_PHP,data:{statusCode:i.NO_REVIEWS_MATCH_SETTINGS}})}))})),void(await O(o));let r=[];const n=await U.getQueue();r=t.filter((t=>!n.some((e=>e.id===t.id)))),N.enqueues(r)};switch(s){case K.THIS_PAGE:{const{listImport:t}=await st({importTypeStatus:e,shopId:r,rawDomain:o,token:n,importPageType:K.THIS_PAGE});await c(t);break}case K.ALL_PAGES:{let t="",s=!0;const a=[];for(;s;){const i=await st({importTypeStatus:e,cursor:t||"",shopId:r,rawDomain:o,token:n,importPageType:K.ALL_PAGES});t=i.nextCursor,s=!!i.nextCursor,a.push(...i.listImport)}await c(a);break}}}catch{const{rawDomain:e}=t.payload;O(e)}}return!0})),chrome.runtime.onMessage.addListener(((t,e,s)=>{switch(t.message){case D.GENERATE_ALL_LINK_AFFILIATE:(async(t,e)=>{try{const s=(await Promise.all(t.productIds.map((async t=>{const{promotion_link:e}=await Q(t);if(!e)return null;const s=await J(e);return s?{[t]:s}:null})))).filter((t=>null!==t)).reduce(((t,e)=>({...t,...e})),{});e(Object.keys(s).length?s:null)}catch{e(null)}})(t.payload,s);break;case D.ADD_CUSTOM_SCRIPT_TO_DOM:it(rt,t.payload,s);break;case D.ADD_OPR_BANNER_TO_DOM:it(ot,t.payload,s)}return!0})),chrome.runtime.onMessage.addListener(((t,e,s)=>{const{type:a,tabId:r=null,options:o={}}=t;switch(a){case G.GET_TABS:ct(o,s);break;case G.SENDER_FROM_TAB:s(e.tab);break;case G.UPDATE_TAB:lt(r,o,s)}return!0})),chrome.runtime.onMessageExternal.addListener((async(m,S,T)=>{var A;const{type:f,action:b,settings:P,aliExpressUrl:L="",amazonUrl:R=""}=m;switch(f&&T(f),b){case tt.GET_REVIEW_ALIEXPRESS_PHP:try{const t=await h(L,P);await I(P,t.statusCode,t.message)}catch(v){const t=v;await I(P,null==(A=t.response)?void 0:A.status,t.message)}finally{await y(L,P)}break;case tt.GET_REVIEW_ALIEXPRESS_GO:try{const t=await g(L,P);await w(P,t.statusCode,t.message)}catch(v){const t=v;await w(P,t.response.status,t.message)}finally{await E(L,P)}break;case tt.GET_REVIEW_AMAZON_GO:try{const n=await(async(n,c)=>{const{max_number_per_save:l,get_max_number_review:u}=c;let d=0,m=0,p=1;try{const{shop_raw_domain:_}=c,{countries:w}=await t(_),E=Array.isArray(w)?w.reduce(((t,e,s)=>(t[e]=s.toString(),t)),{}):{},g=+l||W,h=+u||100;let I=!0,y=[],S=!1;for(;I;){const{crawlUrl:t,countryFromHost:l}=e(n,c,p)||{},u=await s(t||"");if((u.includes("captchacharacters")||u.includes("SignInClaimCollect"))&&!m){S=!0;break}const _=a(u,c,l||"",E);if(_.length){if(y=y.concat(_),y.length>=g){const t=await r(c,{reviews:y,url:n,platform:o.AMAZON,currentPage:p});if(y=[],!t)break;if(I=t.is_accept_review,d+=t.total_collect_by_request,m+=t.total_collect_by_request+t.total_duplicated_by_request,d>=h)break}p++}else{if(1===p)return{settings:c,statusCode:i.NO_REVIEWS,message:"",data:null};I=!1}n.includes("customer-reviews")&&(I=!1)}if(y.length){const t=await r(c,{reviews:y,url:n,platform:o.AMAZON,currentPage:p});t&&(m+=t.total_collect_by_request+t.total_duplicated_by_request)}if(!m&&S)return{settings:c,statusCode:i.AMAZON_ERROR,message:"Amazon error",data:null};return{settings:c,statusCode:m?i.SUCCESS:i.NO_REVIEWS_MATCH_SETTINGS,message:m?"Success":"Please change settings to match the existing review base.",data:{importedReviews:d,totalReviews:m}}}catch(v){const e=v;return{settings:c,statusCode:e.response.status,message:e.message,data:null}}})(R,P);await w(P,n.statusCode,n.message)}catch(v){const t=v;await w(P,t.response.status,t.message)}finally{await E(R,P)}break;case tt.GET_REVIEW_AMAZON_PHP:try{const t=await(async(t,e)=>{const{quantity_import:s}=e;let a=0,r=0,o=1;try{const m=await n(),p=Array.isArray(m)?m.reduce(((t,e,s)=>(t[e]=s.toString(),t)),{}):{},_=+s||100;let w=!0,E=!1;for(;w;){const{crawlUrl:s,countryFromHost:n}=c(t,e,o)||{},m=await l(s||"");if((m.includes("captchacharacters")||m.includes("SignInClaimCollect"))&&!r){E=!0;break}const g=u(m,e,n||"",p),h=Y(g,e);if(g.length){if(h.length){const s=await d(e,{reviews:h,url_amazon:t,page:o});if(!(null==s?void 0:s.status))break;if(w=s.to_be_continued,a+=s.collect_reviews,r+=s.collect_reviews+s.total_duplicate,a>=_)break}o++}else{if(1===o)return{settings:e,statusCode:i.NO_REVIEWS,message:"",data:null};w=!1}t.includes("customer-reviews")&&(w=!1)}if(!r&&E)return{settings:e,statusCode:i.AMAZON_ERROR,message:"Amazon error",data:null};return{settings:e,statusCode:r?i.SUCCESS:i.NO_REVIEWS_MATCH_SETTINGS,message:r?"Success":"Please change settings to match the existing review base.",data:{importedReviews:a,totalReviews:r}}}catch(v){const s=v;return{settings:e,statusCode:s.response.status,message:s.message,data:null}}})(R,P);await p(P,t.statusCode,t.message,R)}catch(v){const t=v;await p(P,t.response.status,t.message,R)}finally{await _(R,P)}}return!0})),chrome.webRequest.onSendHeaders.addListener((t=>{t.url.includes("account-user-bff/v1/users/info")&&(chrome.storage.local.set({dataStoreDser:t.requestHeaders},(()=>{})),chrome.storage.local.set({urlUserInfo:t.url},(()=>{}))),t.url.includes("dsers-product-bff/my-product?storeId=")&&!t.url.includes("seller-link")&&chrome.storage.local.set({productsListUrl:t.url},(()=>{})),t.url.includes("/api/v1/prod/list")&&!t.url.includes("isAr=true")&&(chrome.storage.local.set({dataProductListDser:t.requestHeaders},(()=>{})),chrome.storage.local.set({dataUrlGetListProduct:t.url},(()=>{})))}),{urls:["https://*.dsers.com/*"]},["extraHeaders","requestHeaders"]);const ut=()=>{H(),x()};ut(),chrome.runtime.onStartup.addListener((()=>{ut()})),chrome.tabs.onUpdated.addListener(((t,e)=>{e.url&&chrome.tabs.sendMessage(t,{type:"URL_CHANGED",url:e.url})}));
